name: MeatMetrics CI Pipeline

# èªè¨¼ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«å®Ÿè£…å®Œäº†æ™‚ç‚¹ã§ã®CIæˆ¦ç•¥
# JUnité‡è¦–ã€æ®µéšçš„æ‹¡å¼µã€Dockeré–‹ç™ºç’°å¢ƒæ´»ç”¨

on:
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".gitignore"
  push:
    branches: [main]
    paths-ignore:
      - "docs/**"
      - "*.md"
      - ".gitignore"

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ç’°å¢ƒå¤‰æ•°
env:
  JAVA_VERSION: "17"
  NODE_VERSION: "18"
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository -Xmx1024m"

jobs:
  # ==============================================================================
  # Stage 1: Backend Basic Test (æ®µéšçš„CIæ§‹ç¯‰ - æœ€å°æ§‹æˆ)
  # PostgreSQL/Flyway/ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¯ä¸€æ—¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ç¢ºèªã®ã¿
  # ==============================================================================
  backend-test:
    name: ğŸ§ª Backend Basic Test (Minimal)
    runs-on: ubuntu-latest

    # PostgreSQLã‚µãƒ¼ãƒ“ã‚¹ã‚³ãƒ³ãƒ†ãƒŠã¯ä¸€æ—¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆæ®µéšçš„CIæ§‹ç¯‰ï¼‰
    # services:
    #   postgres:
    #     image: postgres:16
    #     env:
    #       POSTGRES_DB: meatmetrics_test
    #       POSTGRES_USER: meatmetrics
    #       POSTGRES_PASSWORD: meatmetrics123
    #     options: >-
    #       --health-cmd pg_isready
    #       --health-interval 10s
    #       --health-timeout 5s
    #       --health-retries 5
    #     ports:
    #       - 5432:5432

    defaults:
      run:
        working-directory: ./backend

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: ${{ env.JAVA_VERSION }}
          cache: "maven"

      - name: ğŸ“¦ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      - name: ğŸ” Verify Maven Configuration
        run: |
          mvn --version
          mvn help:effective-pom -q

      - name: ğŸ§ª Run Basic Unit Tests (No DB)
        # PostgreSQLã¨Flywayã¯ä¸€æ—¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆæ®µéšçš„CIæ§‹ç¯‰ï¼‰
        # env:
        #   SPRING_PROFILES_ACTIVE: test
        #   SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/meatmetrics_test
        #   SPRING_DATASOURCE_USERNAME: meatmetrics
        #   SPRING_DATASOURCE_PASSWORD: meatmetrics123
        #   SPRING_FLYWAY_ENABLED: true
        #   SPRING_FLYWAY_CLEAN_DISABLED: false
        run: |
          # Flywayãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã¯ä¸€æ—¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
          # mvn flyway:info flyway:migrate \
          #   -B \
          #   -Dspring.profiles.active=test

          # ã¾ãšã¯æœ€å°é™ã®ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ç¢ºèªã®ã¿
          mvn clean compile \
            -B \
            --fail-at-end

          # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚‚ä¸€æ—¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
          # mvn test \
          #   -B \
          #   -Dspring.profiles.active=test \
          #   -Dmaven.test.failure.ignore=false \
          #   --fail-at-end

      # ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã¯ä¸€æ—¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆæ®µéšçš„CIæ§‹ç¯‰ï¼‰
      # - name: ğŸ“Š Generate Test Report
      #   if: always()
      #   run: |
      #     find target/surefire-reports -name "*.xml" -exec cat {} \;
      #
      # - name: ğŸ“ˆ Upload Test Results
      #   if: always()
      #   uses: dorny/test-reporter@v1
      #   with:
      #     name: "Backend JUnit Test Results"
      #     path: "backend/target/surefire-reports/*.xml"
      #     reporter: "java-junit"
      #
      # - name: ğŸ’¾ Archive Test Reports
      #   if: always()
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: backend-test-reports
      #     path: backend/target/surefire-reports/

  # ==============================================================================
  # Stage 2: Build Verification (ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ç¢ºèª) - ä¸€æ—¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
  # ==============================================================================
  # backend-build:
  #   name: ğŸ—ï¸ Backend Build Verification
  #   runs-on: ubuntu-latest
  #   needs: backend-test
  #   defaults:
  #     run:
  #       working-directory: ./backend
  #
  #   steps:
  #     - name: ğŸ“¥ Checkout Repository
  #       uses: actions/checkout@v4
  #
  #     - name: â˜• Setup Java 17
  #       uses: actions/setup-java@v4
  #       with:
  #         distribution: "temurin"
  #         java-version: ${{ env.JAVA_VERSION }}
  #         cache: "maven"
  #
  #     - name: ğŸ“¦ Cache Maven Dependencies
  #       uses: actions/cache@v4
  #       with:
  #         path: ~/.m2/repository
  #         key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
  #         restore-keys: |
  #           ${{ runner.os }}-maven-
  #
  #     - name: ğŸ—ï¸ Build Application (Skip Tests)
  #       run: |
  #         mvn clean package \
  #           -B \
  #           -DskipTests \
  #           -Dspring.profiles.active=prod \
  #           --fail-at-end
  #
  #     - name: ğŸ“Š Verify JAR Creation
  #       run: |
  #         ls -la target/*.jar
  #         java -jar target/*.jar --version || echo "JAR verification completed"
  #
  #     - name: ğŸ’¾ Archive Build Artifacts
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: backend-jar
  #         path: backend/target/*.jar
  #         retention-days: 7

  # ==============================================================================
  # Stage 2: Frontend Basic Check (æ®µéšçš„CIæ§‹ç¯‰ - æœ€å°æ§‹æˆ)
  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¯ä¸€æ—¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆã—ã€å‹ãƒã‚§ãƒƒã‚¯+ãƒ“ãƒ«ãƒ‰ç¢ºèªã®ã¿
  # ==============================================================================
  frontend-check:
    name: ğŸ¨ Frontend Basic Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "frontend/package-lock.json"

      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci --prefer-offline --no-audit

      - name: ğŸ” TypeScript Check
        run: |
          npm run type-check || npx tsc --noEmit

      # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¯ä¸€æ—¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆï¼ˆæ®µéšçš„CIæ§‹ç¯‰ï¼‰
      # - name: ğŸ§ª Run Unit Tests
      #   run: |
      #     npm run test:run

      - name: ğŸ—ï¸ Build Verification
        run: |
          npm run build

      # è©³ç´°ãªãƒã‚§ãƒƒã‚¯ã¯ä¸€æ—¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
      # - name: ğŸ“Š Bundle Size Check
      #   run: |
      #     ls -la dist/
      #     du -sh dist/

      # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜ã¯ä¸€æ—¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
      # - name: ğŸ’¾ Archive Frontend Build
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: frontend-build
      #     path: frontend/dist/
      #     retention-days: 7

  # ==============================================================================
  # Stage 4: Security & Quality Gates (åŸºæœ¬) - ä¸€æ—¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
  # ==============================================================================
  # security-scan:
  #   name: ğŸ”’ Security & Dependency Scan
  #   runs-on: ubuntu-latest
  #   if: github.event_name == 'pull_request'
  #
  #   steps:
  #     - name: ğŸ“¥ Checkout Repository
  #       uses: actions/checkout@v4
  #
  #     - name: ğŸ” Run OSSAR (GitHub Security Scanner)
  #       uses: github/ossar-action@v1
  #       id: ossar
  #
  #     - name: ğŸ“Š Upload SARIF Results
  #       if: always()
  #       uses: github/codeql-action/upload-sarif@v3
  #       with:
  #         sarif_file: ${{ steps.ossar.outputs.sarifFile }}

  # ==============================================================================
  # Summary Job (å…¨ã‚¸ãƒ§ãƒ–ã®çµæœé›†ç´„) - ä¸€æ—¦ã‚³ãƒ¡ãƒ³ãƒˆã‚¢ã‚¦ãƒˆ
  # ==============================================================================
  # ci-summary:
  #   name: ğŸ“‹ CI Summary
  #   runs-on: ubuntu-latest
  #   needs: [backend-test, backend-build, frontend-check]
  #   if: always()
  #
  #   steps:
  #     - name: ğŸ“Š Check All Job Results
  #       run: |
  #         echo "=== CI Pipeline Summary ==="
  #         echo "Backend Tests: ${{ needs.backend-test.result }}"
  #         echo "Backend Build: ${{ needs.backend-build.result }}"
  #         echo "Frontend Check: ${{ needs.frontend-check.result }}"
  #
  #         if [ "${{ needs.backend-test.result }}" = "failure" ] ||
  #            [ "${{ needs.backend-build.result }}" = "failure" ] ||
  #            [ "${{ needs.frontend-check.result }}" = "failure" ]; then
  #           echo "âŒ CI Pipeline Failed"
  #           exit 1
  #         else
  #           echo "âœ… CI Pipeline Passed"
  #         fi

# ==============================================================================
# Future Extensions (Phase 2ä»¥é™ã§æ®µéšçš„ã«è¿½åŠ )
# ==============================================================================
#
# integration-test:
#   - Testcontainers + PostgreSQL
#   - @DataJpaTest, @SpringBootTest
#   - Spring Securityçµ±åˆãƒ†ã‚¹ãƒˆ
#
# docker-build:
#   - ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸Dockerãƒ“ãƒ«ãƒ‰
#   - ã‚¤ãƒ¡ãƒ¼ã‚¸ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
#   - ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¸ã®ãƒ—ãƒƒã‚·ãƒ¥
#
# deployment:
#   - Stagingç’°å¢ƒã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
#   - Productionç’°å¢ƒã¸ã®æ‰‹å‹•æ‰¿èªãƒ‡ãƒ—ãƒ­ã‚¤
#   - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµ±åˆ
# ==============================================================================
