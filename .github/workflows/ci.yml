name: MeatMetrics CI Pipeline

# èªè¨¼ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«å®Ÿè£…å®Œäº†æ™‚ç‚¹ã§ã®CIæˆ¦ç•¥
# JUnité‡è¦–ã€æ®µéšçš„æ‹¡å¼µã€Dockeré–‹ç™ºç’°å¢ƒæ´»ç”¨

on:
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'
  push:
    branches: [ main ]
    paths-ignore:
      - 'docs/**'
      - '*.md'
      - '.gitignore'

# ã‚°ãƒ­ãƒ¼ãƒãƒ«ç’°å¢ƒå¤‰æ•°
env:
  JAVA_VERSION: '17'
  NODE_VERSION: '18'
  MAVEN_OPTS: '-Dmaven.repo.local=.m2/repository -Xmx1024m'

jobs:
  # ==============================================================================
  # Stage 1: Backend JUnit Tests (æœ€å„ªå…ˆ - èªè¨¼ãƒ‰ãƒ¡ã‚¤ãƒ³å¯¾å¿œ)
  # ==============================================================================
  backend-test:
    name: ğŸ§ª Backend Unit Tests (JUnit 5)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./backend
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'
          
      - name: ğŸ“¦ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
            
      - name: ğŸ” Verify Maven Configuration
        run: |
          mvn --version
          mvn help:effective-pom -q
          
      - name: ğŸ§ª Run Unit Tests (èªè¨¼ãƒ‰ãƒ¡ã‚¤ãƒ³ä¸­å¿ƒ)
        run: |
          mvn clean test \
            -B \
            -Dspring.profiles.active=test \
            -Dmaven.test.failure.ignore=false \
            --fail-at-end
            
      - name: ğŸ“Š Generate Test Report
        if: always()
        run: |
          find target/surefire-reports -name "*.xml" -exec cat {} \;
          
      - name: ğŸ“ˆ Upload Test Results
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: 'Backend JUnit Test Results'
          path: 'backend/target/surefire-reports/*.xml'
          reporter: 'java-junit'
          
      - name: ğŸ’¾ Archive Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-test-reports
          path: backend/target/surefire-reports/

  # ==============================================================================
  # Stage 2: Build Verification (ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ãƒ»ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°ç¢ºèª)
  # ==============================================================================
  backend-build:
    name: ğŸ—ï¸ Backend Build Verification
    runs-on: ubuntu-latest
    needs: backend-test
    defaults:
      run:
        working-directory: ./backend
        
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'maven'
          
      - name: ğŸ“¦ Cache Maven Dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-
            
      - name: ğŸ—ï¸ Build Application (Skip Tests)
        run: |
          mvn clean package \
            -B \
            -DskipTests \
            -Dspring.profiles.active=prod \
            --fail-at-end
            
      - name: ğŸ“Š Verify JAR Creation
        run: |
          ls -la target/*.jar
          java -jar target/*.jar --version || echo "JAR verification completed"
          
      - name: ğŸ’¾ Archive Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: backend-jar
          path: backend/target/*.jar
          retention-days: 7

  # ==============================================================================
  # Stage 3: Frontend Basic Verification (è»½é‡åŒ–)
  # ==============================================================================
  frontend-check:
    name: ğŸ¨ Frontend Basic Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend
        
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'
          
      - name: ğŸ“¦ Install Dependencies
        run: |
          npm ci --prefer-offline --no-audit
          
      - name: ğŸ” TypeScript Check
        run: |
          npm run type-check || npx tsc --noEmit
          
      - name: ğŸ—ï¸ Build Verification
        run: |
          npm run build
          
      - name: ğŸ“Š Bundle Size Check
        run: |
          ls -la dist/
          du -sh dist/
          
      - name: ğŸ’¾ Archive Frontend Build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: frontend/dist/
          retention-days: 7

  # ==============================================================================
  # Stage 4: Security & Quality Gates (åŸºæœ¬)
  # ==============================================================================
  security-scan:
    name: ğŸ”’ Security & Dependency Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ğŸ” Run OSSAR (GitHub Security Scanner)
        uses: github/ossar-action@v1
        id: ossar
        
      - name: ğŸ“Š Upload SARIF Results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.ossar.outputs.sarifFile }}

  # ==============================================================================
  # Summary Job (å…¨ã‚¸ãƒ§ãƒ–ã®çµæœé›†ç´„)
  # ==============================================================================
  ci-summary:
    name: ğŸ“‹ CI Summary
    runs-on: ubuntu-latest
    needs: [backend-test, backend-build, frontend-check]
    if: always()
    
    steps:
      - name: ğŸ“Š Check All Job Results
        run: |
          echo "=== CI Pipeline Summary ==="
          echo "Backend Tests: ${{ needs.backend-test.result }}"
          echo "Backend Build: ${{ needs.backend-build.result }}"
          echo "Frontend Check: ${{ needs.frontend-check.result }}"
          
          if [ "${{ needs.backend-test.result }}" = "failure" ] || 
             [ "${{ needs.backend-build.result }}" = "failure" ] || 
             [ "${{ needs.frontend-check.result }}" = "failure" ]; then
            echo "âŒ CI Pipeline Failed"
            exit 1
          else
            echo "âœ… CI Pipeline Passed"
          fi

# ==============================================================================
# Future Extensions (Phase 2ä»¥é™ã§æ®µéšçš„ã«è¿½åŠ )
# ==============================================================================
# 
# integration-test:
#   - Testcontainers + PostgreSQL
#   - @DataJpaTest, @SpringBootTest
#   - Spring Securityçµ±åˆãƒ†ã‚¹ãƒˆ
#
# docker-build:
#   - ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸Dockerãƒ“ãƒ«ãƒ‰
#   - ã‚¤ãƒ¡ãƒ¼ã‚¸ã®è„†å¼±æ€§ã‚¹ã‚­ãƒ£ãƒ³
#   - ãƒ¬ã‚¸ã‚¹ãƒˆãƒªã¸ã®ãƒ—ãƒƒã‚·ãƒ¥
#
# deployment:
#   - Stagingç’°å¢ƒã¸ã®è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
#   - Productionç’°å¢ƒã¸ã®æ‰‹å‹•æ‰¿èªãƒ‡ãƒ—ãƒ­ã‚¤
#   - ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµ±åˆ
# ==============================================================================
