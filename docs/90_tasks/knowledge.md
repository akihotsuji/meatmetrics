# 開発知識・学び集 📚

## 2025 年 8 月 10 日

### 完了した作業

- PostgreSQL 16 環境の構築完了
- Spring Boot アプリケーションの DB 接続設定完了
- プロジェクトタスク管理ファイルの更新完了

### 重要な学び

#### 1. Docker ボリュームと PostgreSQL バージョン互換性

- **問題**: PostgreSQL 15 で初期化されたデータディレクトリを PostgreSQL 16 が使用しようとして起動失敗
- **原因**: Docker Compose が既存のボリューム`postgres_data`を再利用していた
- **解決策**: ボリューム名を`postgres16_data`に変更し、クリーンな初期化を実現
- **学び**: PostgreSQL のメジャーバージョン間ではデータディレクトリの互換性がないため、ボリューム名の管理が重要

#### 2. Windows Git Bash 環境での Maven Wrapper 実行

- **問題**: `./mvnw`コマンドが実行できない
- **原因**: Windows 環境では`mvnw.cmd`を使用する必要がある
- **解決策**: `mvnw.cmd`を使用、または`cmd.exe /c`で実行
- **学び**: Windows 環境でのコマンド実行時は、適切なファイル拡張子と実行方法を確認

#### 3. Maven プロジェクトの実行ディレクトリ

- **問題**: プロジェクトルートから Maven コマンドを実行すると「POM が見つからない」エラー
- **原因**: `pom.xml`が`backend/`サブディレクトリに配置されている
- **解決策**: `backend/`ディレクトリに移動するか、`-f backend/pom.xml`でパス指定
- **学び**: モノレポ構成では、各プロジェクトの実行ディレクトリを正確に把握する必要

#### 4. Spring Boot アプリケーションの起動確認

- **問題**: アプリケーション起動後に「Whitelabel Error Page」が表示される
- **原因**: ルートパス（`/`）にマッピングされたコントローラーやコンテンツがない
- **解決策**: これは正常な動作で、エラーではない
- **学び**: Spring Boot アプリケーションの起動確認は、ログの確認と DB 接続テストが重要

### 躓きポイント・解決策

#### 1. PostgreSQL 起動エラーの切り分け

- **問題**: `FATAL: database files are incompatible with server`エラー
- **切り分け手順**:
  1. Docker コンテナのログ確認
  2. ボリュームの詳細確認（`docker volume inspect`）
  3. ボリューム名の履歴確認
- **解決策**: ボリューム名の変更によるクリーン初期化

#### 2. Maven コマンド実行の環境依存問題

- **問題**: 同じコマンドが環境によって動作が異なる
- **切り分け手順**:
  1. 実行ディレクトリの確認
  2. ファイルの存在確認
  3. 環境変数の確認
- **解決策**: 環境に応じた適切なコマンド形式の選択

### 今後の注意点

#### 1. データベース環境構築

- PostgreSQL のメジャーバージョンアップ時は、必ずボリューム名を変更
- 初期化スクリプトの配置と権限設定
- データベース接続情報の適切な管理

---

## 2025 年 8 月 11 日

### 完了した作業

- Docker 構成の dev/prod 分離完了（Compose を `dev/` と `prod/` に分割）
- PostgreSQL を Dockerfile ビルドに統一（`postgres/Dockerfile(.dev)`）
- 本番は DB ポート非公開、開発のみ `15432:5432` 公開に統一
- ドキュメント更新（`docs/docker/*.md` / Qiita 記事）

### 重要な学び

1. Mermaid 図の特殊文字

   - ノードラベル内の括弧 `()` は形状終端と競合することがある
   - `Port: 3000 (dev)` → `Port: 3000 - dev` のように表現を避ける

2. Compose のビルドコンテキスト

   - サブディレクトリ起点の `context`/`dockerfile` は相対パスの基準が異なる
   - `dev/` と `prod/` で `../../../backend` のように見直しが必要

3. DB 公開ポートの方針
   - 開発のみ公開、本番は内部ネットワーク運用が安全
   - 管理用接続が必要な場合は一時的公開か踏み台/ポートフォワードを選択

### 今後の注意点

- CI/CD の参照パス（`infrastructure/docker/prod` 起点）を統一
- 本番の環境変数は `.env` 直置きではなく Secrets 管理を前提
- ドキュメント中の古い `docker-compose` 記法は `docker compose` に順次統一

#### 2. 開発環境の統一

- チーム内での実行環境の統一
- コマンド実行手順のドキュメント化
- 環境依存の問題の早期発見と対策

#### 3. アプリケーション起動確認の標準化

- ログ確認の手順統一
- ヘルスチェックエンドポイントの実装
- エラーと正常動作の区別方法

---

## 技術的知見

### Docker 環境での PostgreSQL 運用

- **ボリューム管理**: 名前付きボリュームの適切な命名規則
- **バージョン互換性**: メジャーバージョン間でのデータディレクトリ互換性の確認
- **初期化スクリプト**: `/docker-entrypoint-initdb.d`への配置方法

### Spring Boot + PostgreSQL 連携

- **接続設定**: `application.properties`でのデータベース接続情報設定
- **起動確認**: ログ確認と DB 接続テストの重要性
- **エラーハンドリング**: 正常な動作とエラーの区別

### Mermaid 図の安定描画ルール（実務）

- ノードラベル内の括弧 `()` やスラッシュ `/` の多用は避け、必要ならダブルクオートで囲む
- sequenceDiagram の participant・メッセージはダブルクオートで安全
- 記号は `-` や `:` を使い、形状指定と衝突しないようにする

### CI/CD の基本設計

- PR で backend-test / frontend-test を必須化し、Green でマージ可
- main への push で build 実行、必要時 Docker build/push
- Secrets 管理（DB 接続、JWT 秘密鍵、Registry 認証）は GitHub Secrets

### Windows 開発環境での注意点

- **コマンド実行**: 適切なファイル拡張子の選択
- **パス管理**: プロジェクト構造に応じた実行ディレクトリの把握
- **環境依存**: クロスプラットフォーム対応の重要性

---

**最終更新**: 2025 年 8 月 10 日  
**更新者**: 開発チーム  
**次回更新予定**: 開発環境構築完了後
