# Spring Boot + Flyway ã§ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè·µï¼ˆDocker + PostgreSQL ç’°å¢ƒï¼‰

Spring Boot ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ Flyway ã‚’ä½¿ã£ãŸãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…ã¨é‹ç”¨ã«ã¤ã„ã¦ã€å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç’°å¢ƒã‚’ãƒ™ãƒ¼ã‚¹ã«è©³ã—ãè§£èª¬ã—ã¾ã™ã€‚Docker + PostgreSQL ç’°å¢ƒã§ã®å®Ÿè·µçš„ãªè¨­å®šã‹ã‚‰ã€ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆãƒ»ç®¡ç†ã¾ã§ä¸€æ°—é€šè²«ã§ã‚«ãƒãƒ¼ã—ã¾ã™ã€‚

---

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ§‹æˆ

### ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ 

```
sample-app/
â”œâ”€â”€ backend/                              # Spring Boot ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³
â”‚   â”œâ”€â”€ pom.xml                          # Mavenä¾å­˜é–¢ä¿‚å®šç¾©
â”‚   â”œâ”€â”€ src/main/
â”‚   â”‚   â”œâ”€â”€ java/com/example/sampleapp/  # Javaã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
â”‚   â”‚   â””â”€â”€ resources/
â”‚   â”‚       â”œâ”€â”€ application.properties            # åŸºæœ¬è¨­å®š
â”‚   â”‚       â”œâ”€â”€ application-dev.properties        # é–‹ç™ºç’°å¢ƒè¨­å®š
â”‚   â”‚       â””â”€â”€ db/migration/                     # ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”‚           â”œâ”€â”€ V001__create_users_table.sql
â”‚   â”‚           â”œâ”€â”€ V002__insert_test_users.sql
â”‚   â”‚           â”œâ”€â”€ V003__create_products_table.sql
â”‚   â”‚           â””â”€â”€ V004__insert_initial_data.sql
â”‚   â””â”€â”€ target/                          # ãƒ“ãƒ«ãƒ‰æˆæœç‰©
â”œâ”€â”€ frontend/                            # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆReactç­‰ï¼‰
â”œâ”€â”€ infrastructure/docker/               # Dockeré–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«
â”‚   â”œâ”€â”€ dev/docker-compose.yml          # é–‹ç™ºç’°å¢ƒç”¨Compose
â”‚   â”œâ”€â”€ prod/docker-compose.yml         # æœ¬ç•ªç’°å¢ƒç”¨Compose
â”‚   â”œâ”€â”€ backend/Dockerfile              # Spring Bootç”¨Dockerfile
â”‚   â”œâ”€â”€ frontend/Dockerfile             # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”¨Dockerfile
â”‚   â””â”€â”€ postgres/Dockerfile.dev         # PostgreSQLé–‹ç™ºç”¨
â””â”€â”€ docs/                               # ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
```

---

## å…¨ä½“æ§‹æˆã¨ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ä½ç½®ã¥ã‘

### ã‚·ã‚¹ãƒ†ãƒ æ§‹æˆå›³

```mermaid
graph TB
  subgraph Docker Environment
    SB[Spring Boot App]
    PG[(PostgreSQL 16)]
    FW[Flyway Migration]
  end

  subgraph Migration Files
    V1[V001__create_users_table.sql]
    V2[V002__insert_test_users.sql]
    V3[V003__create_products_table.sql]
    VN[V004__insert_initial_data.sql]
  end

  SB --> PG
  FW --> PG
  V1 --> FW
  V2 --> FW
  V3 --> FW
  VN --> FW

  subgraph Migration History
    MH[(flyway_schema_history)]
  end

  FW --> MH
```

### ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°

- **Spring Boot èµ·å‹•æ™‚**ï¼šè‡ªå‹•å®Ÿè¡Œï¼ˆæ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®ã¿ï¼‰
- **æ—¢å­˜ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**ï¼š`flyway_schema_history` ãƒ†ãƒ¼ãƒ–ãƒ«ã§ç®¡ç†ãƒ»ã‚¹ã‚­ãƒƒãƒ—
- **è¿½åŠ ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³**ï¼šé€£ç•ªã§è¿½åŠ ãƒ»è‡ªå‹•å®Ÿè¡Œ

---

## ç’°å¢ƒè¨­å®š

### 1. ä¾å­˜é–¢ä¿‚ã®è¨­å®šï¼ˆpom.xmlï¼‰

```xml
<dependencies>
    <!-- Spring Boot Data JPA -->
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-data-jpa</artifactId>
    </dependency>

    <!-- PostgreSQL Driver -->
    <dependency>
        <groupId>org.postgresql</groupId>
        <artifactId>postgresql</artifactId>
        <scope>runtime</scope>
    </dependency>

    <!-- Flyway Core -->
    <dependency>
        <groupId>org.flywaydb</groupId>
        <artifactId>flyway-core</artifactId>
        <version>10.21.0</version>
    </dependency>

    <!-- Flyway PostgreSQL Support -->
    <dependency>
        <groupId>org.flywaydb</groupId>
        <artifactId>flyway-database-postgresql</artifactId>
        <version>10.21.0</version>
    </dependency>
</dependencies>
```

### 2. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š

**application.properties**

```properties
spring.application.name=sample-app

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆé–‹ç™ºç’°å¢ƒï¼‰
spring.profiles.active=dev

# Flyway åŸºæœ¬è¨­å®š
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
```

**application-dev.properties**

```properties
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šï¼ˆDockerç’°å¢ƒï¼‰
spring.datasource.url=jdbc:postgresql://localhost:15432/sampledb
spring.datasource.username=sampleuser
spring.datasource.password=samplepass123

# JPA/Hibernate è¨­å®š
spring.jpa.hibernate.ddl-auto=none
spring.jpa.open-in-view=false
spring.jpa.properties.hibernate.dialect=org.hibernate.dialect.PostgreSQLDialect

# Flyway è©³ç´°è¨­å®š
spring.flyway.enabled=true
spring.flyway.locations=classpath:db/migration
spring.flyway.baseline-on-migrate=true    # æ—¢å­˜DBã§ã‚‚å®Ÿè¡Œå¯èƒ½
spring.flyway.validate-on-migrate=true    # å®Ÿè¡Œå‰æ¤œè¨¼
spring.flyway.out-of-order=false          # é †åºå®Ÿè¡Œã‚’å¼·åˆ¶
spring.flyway.table=flyway_schema_history  # å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«å
```

### 3. Docker ç’°å¢ƒï¼ˆPostgreSQLï¼‰

**docker-compose.ymlï¼ˆé–‹ç™ºç”¨ï¼‰**

```yaml
version: "3.8"

services:
  postgres:
    image: postgres:16
    container_name: sample-postgres-dev
    environment:
      POSTGRES_DB: sampledb
      POSTGRES_USER: sampleuser
      POSTGRES_PASSWORD: samplepass123
    ports:
      - "15432:5432" # å¤–éƒ¨ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - sample-network

volumes:
  postgres_data:

networks:
  sample-network:
    driver: bridge
```

---

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã®å®Ÿè£…

### ãƒ•ã‚¡ã‚¤ãƒ«å‘½åè¦å‰‡

```
src/main/resources/db/migration/
â”œâ”€â”€ V001__create_users_table.sql       # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
â”œâ”€â”€ V002__insert_test_users.sql        # ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼æŠ•å…¥
â”œâ”€â”€ V003__create_products_table.sql    # å•†å“ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
â”œâ”€â”€ V004__insert_initial_products.sql  # åˆæœŸå•†å“ãƒ‡ãƒ¼ã‚¿
â”œâ”€â”€ V005__create_categories_table.sql  # ã‚«ãƒ†ã‚´ãƒªãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
â”œâ”€â”€ V006__insert_initial_categories.sql # åˆæœŸã‚«ãƒ†ã‚´ãƒªãƒ‡ãƒ¼ã‚¿
â”œâ”€â”€ V007__add_products_category_constraint.sql # å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„è¿½åŠ 
â”œâ”€â”€ V008__create_orders_table.sql      # æ³¨æ–‡ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
â”œâ”€â”€ V009__create_order_items_table.sql # æ³¨æ–‡è©³ç´°ãƒ†ãƒ¼ãƒ–ãƒ«
â””â”€â”€ V010__insert_sample_orders.sql     # ã‚µãƒ³ãƒ—ãƒ«æ³¨æ–‡ãƒ‡ãƒ¼ã‚¿
```

**å‘½åè¦å‰‡**ï¼š`V{é€£ç•ª}__{èª¬æ˜}.sql`

- é€£ç•ªã¯å¿…ãš 3 æ¡ä»¥ä¸Šï¼ˆV001, V002...ï¼‰
- ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ 2 ã¤ã§åŒºåˆ‡ã‚‹
- èª¬æ˜ã¯è‹±èªã€ã‚¹ãƒãƒ¼ã‚¯ã‚±ãƒ¼ã‚¹æ¨å¥¨

### å®Ÿéš›ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä¾‹

**V001\_\_create_users_table.sql**

```sql
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆusersï¼‰ã®ä½œæˆ
-- åŸºæœ¬çš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨è¨­å®šã‚’å«ã‚€

CREATE TABLE IF NOT EXISTS users (
    -- åŸºæœ¬æƒ…å ±
    id BIGSERIAL PRIMARY KEY,
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,

    -- ãƒ¦ãƒ¼ã‚¶ãƒ¼è¨­å®š
    status VARCHAR(20) DEFAULT 'ACTIVE',
    role VARCHAR(20) DEFAULT 'USER',
    last_login_at TIMESTAMP WITH TIME ZONE,
    email_verified BOOLEAN DEFAULT FALSE,

    -- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³åˆ¶ç´„
    CONSTRAINT users_email_format CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'),
    CONSTRAINT users_username_length CHECK (char_length(username) >= 3 AND char_length(username) <= 30),
    CONSTRAINT users_status_valid CHECK (status IN ('ACTIVE', 'INACTIVE', 'SUSPENDED')),
    CONSTRAINT users_role_valid CHECK (role IN ('USER', 'ADMIN', 'MODERATOR'))
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨­è¨ˆ
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_created_at ON users(created_at);

-- æ›´æ–°æ—¥æ™‚ã®è‡ªå‹•æ›´æ–°ãƒˆãƒªã‚¬ãƒ¼
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = CURRENT_TIMESTAMP;
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at BEFORE UPDATE ON users
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

**V002\_\_insert_test_users.sql**

```sql
-- ãƒ†ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®æŠ•å…¥
-- é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ã®åˆæœŸãƒ‡ãƒ¼ã‚¿

INSERT INTO users (email, username, password_hash, status, role, email_verified) VALUES
('admin@example.com', 'admin', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2uheWG/igi.', 'ACTIVE', 'ADMIN', true),
('user1@example.com', 'user1', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2uheWG/igi.', 'ACTIVE', 'USER', true),
('user2@example.com', 'user2', '$2a$10$92IXUNpkjO0rOQ5byMi.Ye4oKoEa3Ro9llC/.og/at2uheWG/igi.', 'ACTIVE', 'USER', false);

-- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯å…¨ã¦ 'password123' ï¼ˆBCryptãƒãƒƒã‚·ãƒ¥ï¼‰
```

**V007\_\_add_products_category_constraint.sql**

```sql
-- å•†å“ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚«ãƒ†ã‚´ãƒªå¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è¿½åŠ 
-- categories ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆå¾Œã«å®Ÿè¡Œ

-- å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã®è¿½åŠ 
ALTER TABLE products
ADD CONSTRAINT fk_products_category
FOREIGN KEY (category_id) REFERENCES categories(id);

-- ã‚«ãƒ†ã‚´ãƒªæ¤œç´¢ç”¨ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_products_category_id ON products(category_id);
```

---

## ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã®å‹•ä½œä»•çµ„ã¿

### 1. å±¥æ­´ç®¡ç†ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆflyway_schema_historyï¼‰

Flyway ã¯å®Ÿè¡Œæ¸ˆã¿ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ `flyway_schema_history` ãƒ†ãƒ¼ãƒ–ãƒ«ã§ç®¡ç†ã—ã¾ã™ï¼š

```sql
-- è‡ªå‹•ç”Ÿæˆã•ã‚Œã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 
CREATE TABLE flyway_schema_history (
    installed_rank INTEGER NOT NULL,      -- å®Ÿè¡Œé †åº
    version VARCHAR(50),                   -- ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆV001, V002...ï¼‰
    description VARCHAR(200) NOT NULL,    -- èª¬æ˜æ–‡
    type VARCHAR(20) NOT NULL,            -- SQL/JAVAç­‰
    script VARCHAR(1000) NOT NULL,        -- ãƒ•ã‚¡ã‚¤ãƒ«å
    checksum INTEGER,                      -- ãƒ•ã‚¡ã‚¤ãƒ«å†…å®¹ã®ãƒãƒƒã‚·ãƒ¥å€¤
    installed_by VARCHAR(100) NOT NULL,   -- å®Ÿè¡Œãƒ¦ãƒ¼ã‚¶ãƒ¼
    installed_on TIMESTAMP NOT NULL,      -- å®Ÿè¡Œæ—¥æ™‚
    execution_time INTEGER NOT NULL,      -- å®Ÿè¡Œæ™‚é–“ï¼ˆãƒŸãƒªç§’ï¼‰
    success BOOLEAN NOT NULL               -- æˆåŠŸ/å¤±æ•—
);
```

### 2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
    A[Spring Boot èµ·å‹•] --> B[Flyway åˆæœŸåŒ–]
    B --> C[migration ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚¹ã‚­ãƒ£ãƒ³]
    C --> D[flyway_schema_history ç¢ºèª]
    D --> E{æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³?}
    E -->|Yes| F[ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ]
    E -->|No| G[ã‚¹ã‚­ãƒƒãƒ—]
    F --> H[ãƒã‚§ãƒƒã‚¯ã‚µãƒ è¨ˆç®—]
    H --> I[å±¥æ­´ãƒ†ãƒ¼ãƒ–ãƒ«ã«è¨˜éŒ²]
    I --> J[æ¬¡ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³]
    J --> E
    G --> K[ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•å®Œäº†]
    I --> K
```

### 3. ãƒã‚§ãƒƒã‚¯ã‚µãƒ æ¤œè¨¼

æ—¢å­˜ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ãŒå¤‰æ›´ã•ã‚Œã‚‹ã¨ã€ãƒã‚§ãƒƒã‚¯ã‚µãƒ ä¸ä¸€è‡´ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ï¼š

```
ERROR: Migration checksum mismatch for migration version 1
-> Applied to database : 1234567890
-> Resolved locally    : 9876543210
```

**å¯¾å‡¦æ³•**ï¼š

- **æ¨å¥¨**ï¼šæ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ã§ä¿®æ­£
- **ç·Šæ€¥æ™‚**ï¼š`flyway repair` ã‚³ãƒãƒ³ãƒ‰ã§ä¿®å¾©ï¼ˆæœ¬ç•ªéæ¨å¥¨ï¼‰

---

## é–‹ç™ºãƒ•ãƒ­ãƒ¼

### 1. æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³è¿½åŠ 

```bash
# 1. æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
touch src/main/resources/db/migration/V011__add_user_profiles_table.sql

# 2. SQL ã‚’è¨˜è¿°
cat > src/main/resources/db/migration/V011__add_user_profiles_table.sql << EOF
-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¿½åŠ 
CREATE TABLE user_profiles (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT NOT NULL REFERENCES users(id),
    bio TEXT,
    avatar_url VARCHAR(500),
    phone VARCHAR(20),
    address TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_user_profiles_user_id ON user_profiles(user_id);
EOF

# 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•ï¼ˆè‡ªå‹•çš„ã«ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œï¼‰
./mvnw spring-boot:run
```

### 2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ³ã®ç¢ºèª

```sql
-- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´ç¢ºèª
SELECT installed_rank, version, description, installed_on, success
FROM flyway_schema_history
ORDER BY installed_rank;

-- çµæœä¾‹
-- installed_rank | version | description              | installed_on        | success
-- 1              | 1       | create users table       | 2024-01-15 10:00:00 | t
-- 2              | 2       | insert test users        | 2024-01-15 10:00:01 | t
-- 3              | 3       | create products table    | 2024-01-15 10:00:02 | t
-- ...
-- 11             | 11      | add user profiles table  | 2024-01-15 15:30:00 | t
```

### 3. ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆãƒ‡ãƒ¼ã‚¿ä¿®æ­£ï¼‰

Flyway ã¯ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ãŒãªã„ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿ä¿®æ­£ã¯æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œï¼š

```sql
-- V012__fix_user_data.sql
-- é–“é•ã£ã¦æŠ•å…¥ã—ãŸãƒ‡ãƒ¼ã‚¿ã®ä¿®æ­£

-- ä¸æ­£ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
DELETE FROM users WHERE email LIKE '%invalid%';

-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®ä¿®æ­£
UPDATE users SET status = 'ACTIVE' WHERE status IS NULL;
```

---

## Docker ç’°å¢ƒã§ã®å®Ÿè¡Œæ‰‹é †

### 1. ç’°å¢ƒèµ·å‹•

```bash
# PostgreSQL ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•
cd infrastructure/docker/dev
docker compose up -d postgres

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç¢ºèª
docker compose logs postgres

# æ¥ç¶šãƒ†ã‚¹ãƒˆ
psql -h localhost -p 15432 -U sampleuser -d sampledb -c "SELECT version();"
```

### 2. Spring Boot ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•

```bash
# ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä»˜ãã§èµ·å‹•
cd backend
./mvnw spring-boot:run

# ã¾ãŸã¯ Docker ã‚³ãƒ³ãƒ†ãƒŠã§èµ·å‹•
docker compose up -d backend
```

### 3. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœç¢ºèª

```bash
# ãƒ­ã‚°ã§ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œã‚’ç¢ºèª
docker compose logs backend | grep -i flyway

# å‡ºåŠ›ä¾‹
# 2024-01-15 10:00:00.123  INFO 1 --- [main] o.f.core.internal.command.DbMigrate      : Migrating schema "public" to version "010 - insert sample orders"
# 2024-01-15 10:00:00.234  INFO 1 --- [main] o.f.core.internal.command.DbMigrate      : Successfully applied 10 migrations to schema "public"

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ç›´æ¥ç¢ºèª
psql -h localhost -p 15432 -U sampleuser -d sampledb
\dt  -- ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§
SELECT * FROM flyway_schema_history;  -- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å±¥æ­´
```

---

## ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### 1. ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦æ³•

**ãƒã‚§ãƒƒã‚¯ã‚µãƒ ä¸ä¸€è‡´**

```
Migration checksum mismatch for migration version 1
```

â†’ è§£æ±ºç­–ï¼šæ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯å¤‰æ›´ã›ãšã€æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§ä¿®æ­£

**ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å¤±æ•—**

```
Migration V005__create_categories_table.sql failed
```

â†’ è§£æ±ºç­–ï¼š

1. ã‚¨ãƒ©ãƒ¼åŸå› ã‚’ç‰¹å®šï¼ˆSQL æ§‹æ–‡ã€åˆ¶ç´„é•åãªã©ï¼‰
2. å¤±æ•—ã—ãŸãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤ã¾ãŸã¯ã‚¹ã‚­ãƒƒãƒ—
3. ä¿®æ­£ç‰ˆã‚’æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ä½œæˆ

**é †åºé•å**

```
Migration V003 was not applied as V004 was already applied
```

â†’ è§£æ±ºç­–ï¼š`spring.flyway.out-of-order=true` ã§è¨±å¯ï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰

### 2. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¿®å¾©ã‚³ãƒãƒ³ãƒ‰

```bash
# Spring Boot ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµŒç”±ã§ã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æƒ…å ±ç¢ºèª
curl http://localhost:8080/actuator/flyway

# Docker çµŒç”±ã§ã®ç›´æ¥æ“ä½œï¼ˆç·Šæ€¥æ™‚ï¼‰
docker exec -it sample-postgres-dev psql -U sampleuser -d sampledb
```

### 3. ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ãƒªã‚¹ãƒˆã‚¢

```bash
# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
docker exec sample-postgres-dev pg_dump -U sampleuser sampledb > backup.sql

# ãƒªã‚¹ãƒˆã‚¢
docker exec -i sample-postgres-dev psql -U sampleuser sampledb < backup.sql
```

---

## æœ¬ç•ªç’°å¢ƒã§ã®è€ƒæ…®äº‹é …

### 1. æœ¬ç•ªç”¨è¨­å®š

**application-prod.properties**

```properties
# æœ¬ç•ªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶š
spring.datasource.url=jdbc:postgresql://production-db:5432/sampledb
spring.datasource.username=${DB_USERNAME}
spring.datasource.password=${DB_PASSWORD}

# Flyway æœ¬ç•ªè¨­å®š
spring.flyway.enabled=true
spring.flyway.baseline-on-migrate=false  # å³å¯†ãªãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†
spring.flyway.validate-on-migrate=true
spring.flyway.clean-disabled=true        # æœ¬ç•ªã§ã®cleanã‚³ãƒãƒ³ãƒ‰ç„¡åŠ¹åŒ–
```

### 2. CI/CD ã§ã®è‡ªå‹•åŒ–

**GitHub Actions ä¾‹**

```yaml
name: Database Migration

on:
  push:
    branches: [main]
    paths: ["backend/src/main/resources/db/migration/**"]

jobs:
  migrate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          java-version: "17"

      - name: Run Flyway Migration
        run: |
          cd backend
          ./mvnw flyway:migrate -Dflyway.url=${{ secrets.DB_URL }}
```

### 3. ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

- **æ©Ÿå¯†æƒ…å ±ã®åˆ†é›¢**ï¼šãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹èªè¨¼æƒ…å ±ã¯ç’°å¢ƒå¤‰æ•°ã§ç®¡ç†
- **æ¨©é™æœ€å°åŒ–**ï¼šãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ã§ DB æ¨©é™ã‚’åˆ†é›¢
- **ç›£æŸ»ãƒ­ã‚°**ï¼šãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œå±¥æ­´ã®è¨˜éŒ²ã¨ç›£è¦–

---

## ã¾ã¨ã‚

Spring Boot + Flyway ã«ã‚ˆã‚‹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç®¡ç†ã®è¦ç‚¹ï¼š

### âœ… ãƒ¡ãƒªãƒƒãƒˆ

- **è‡ªå‹•å®Ÿè¡Œ**ï¼šã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³èµ·å‹•æ™‚ã«è‡ªå‹•ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
- **å±¥æ­´ç®¡ç†**ï¼š`flyway_schema_history` ã«ã‚ˆã‚‹å®Œå…¨ãªå®Ÿè¡Œå±¥æ­´
- **æ•´åˆæ€§ä¿è¨¼**ï¼šãƒã‚§ãƒƒã‚¯ã‚µãƒ ã«ã‚ˆã‚‹ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´æ¤œçŸ¥
- **Docker è¦ªå’Œæ€§**ï¼šã‚³ãƒ³ãƒ†ãƒŠç’°å¢ƒã§ã®ç¢ºå®Ÿãªå®Ÿè¡Œ

### ğŸ”§ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

1. **å‘½åè¦å‰‡ã®å¾¹åº•**ï¼š`V{é€£ç•ª}__{èª¬æ˜}.sql` å½¢å¼
2. **æ®µéšçš„ãªæ§‹ç¯‰**ï¼šãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ â†’ ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ â†’ åˆ¶ç´„è¿½åŠ 
3. **ãƒ†ã‚¹ãƒˆç’°å¢ƒã§ã®äº‹å‰æ¤œè¨¼**ï¼šæœ¬ç•ªé©ç”¨å‰ã®ååˆ†ãªå‹•ä½œç¢ºèª
4. **ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã®ç¿’æ…£åŒ–**ï¼šãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å‰ã®å¿…é ˆä½œæ¥­

### âš ï¸ æ³¨æ„ç‚¹

- **æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ç¦æ­¢**ï¼šãƒã‚§ãƒƒã‚¯ã‚µãƒ ä¸ä¸€è‡´ã‚’é¿ã‘ã‚‹
- **ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯æ©Ÿèƒ½ãªã—**ï¼šä¿®æ­£ã¯æ–°ã—ã„ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œ
- **é †åºã®é‡è¦æ€§**ï¼šä¾å­˜é–¢ä¿‚ã‚’è€ƒæ…®ã—ãŸé€£ç•ªç®¡ç†

ã“ã®æ§‹æˆã«ã‚ˆã‚Šã€**å®‰å…¨ã§ç¢ºå®Ÿãªãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¹ã‚­ãƒ¼ãƒç®¡ç†**ãŒå®Ÿç¾ã§ãã€ãƒãƒ¼ãƒ é–‹ç™ºã§ã®ä¸€è²«æ€§ã¨æœ¬ç•ªç’°å¢ƒã§ã®ä¿¡é ¼æ€§ã‚’ä¸¡ç«‹ã§ãã¾ã™ã€‚
