# JUnit5 ã«ã‚ˆã‚‹ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ä½œæˆï¼šAAA ãƒ‘ã‚¿ãƒ¼ãƒ³ã§å­¦ã¶åŠ¹æœçš„ãªãƒ†ã‚¹ãƒˆå®Ÿè£…

## ã¯ã˜ã‚ã«

æœ¬è¨˜äº‹ã§ã¯ã€JUnit5 ã‚’ä½¿ç”¨ã—ãŸãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã®ä½œæˆæ–¹æ³•ã¨ã€**AAA ãƒ‘ã‚¿ãƒ¼ãƒ³**ï¼ˆArrange-Act-Assertï¼‰ã‚’æ´»ç”¨ã—ãŸåŠ¹æœçš„ãªãƒ†ã‚¹ãƒˆå®Ÿè£…ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

## ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã®åŸºæœ¬æ§‹æˆ

### 1. ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã®ä½œæˆ

```java
@ExtendWith(MockitoExtension.class)
@DisplayName("UserRepository Mockå˜ä½“ãƒ†ã‚¹ãƒˆ")
class UserRepositoryTest {

    @Mock
    private UserRepository userRepository;

    // ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
    private User testUser;
    private Email testEmail;

    @BeforeEach
    void setUp() {
        // å„ãƒ†ã‚¹ãƒˆå‰ã®å…±é€šæº–å‚™å‡¦ç†
        testEmail = new Email("test@example.com");
        testUser = User.register(testEmail, username, password);
    }
}
```

### é‡è¦ãªã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³

| ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³                        | å½¹å‰²                     |
| ------------------------------------- | ------------------------ |
| `@ExtendWith(MockitoExtension.class)` | Mockito ã¨ã®çµ±åˆ         |
| `@DisplayName`                        | ãƒ†ã‚¹ãƒˆã®èª¬æ˜ï¼ˆæ—¥æœ¬èªå¯ï¼‰ |
| `@Mock`                               | ãƒ¢ãƒƒã‚¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä½œæˆ |
| `@BeforeEach`                         | å„ãƒ†ã‚¹ãƒˆå‰ã®åˆæœŸåŒ–       |
| `@Test`                               | ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã®è­˜åˆ¥     |

## AAA ãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè·µ

### AAA ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ã¯

**AAAï¼ˆTriple Aï¼‰ãƒ‘ã‚¿ãƒ¼ãƒ³**ã¯ã€ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ä»¥ä¸‹ã® 3 ã¤ã®ãƒ•ã‚§ãƒ¼ã‚ºã«åˆ†ã‘ã¦è¨˜è¿°ã™ã‚‹æ‰‹æ³•ã§ã™ï¼š

```mermaid
graph LR
    A["ğŸ”§ Arrange<br/>æº–å‚™"] --> B["âš¡ Act<br/>å®Ÿè¡Œ"]
    B --> C["âœ… Assert<br/>æ¤œè¨¼"]

    classDef arrange fill:#e3f2fd
    classDef act fill:#f3e5f5
    classDef assert fill:#e8f5e8

    class A arrange
    class B act
    class C assert
```

### 1. åŸºæœ¬çš„ãª AAA ãƒ‘ã‚¿ãƒ¼ãƒ³

```java
@Test
@DisplayName("findByEmail: å­˜åœ¨ã™ã‚‹ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè¦‹ã¤ã‹ã‚‹")
void findByEmail_UserExists_ReturnsUser() {
    // ğŸ”§ Arrangeï¼ˆæº–å‚™ï¼‰- ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¨ãƒ¢ãƒƒã‚¯ã®è¨­å®š
    when(userRepository.findByEmail(testEmail))
        .thenReturn(Optional.of(testUserWithId));

    // âš¡ Actï¼ˆå®Ÿè¡Œï¼‰- ãƒ†ã‚¹ãƒˆå¯¾è±¡ãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè¡Œ
    Optional<User> result = userRepository.findByEmail(testEmail);

    // âœ… Assertï¼ˆæ¤œè¨¼ï¼‰- çµæœã®æ¤œè¨¼
    assertThat(result).isPresent();
    assertThat(result.get().getEmail()).isEqualTo(testEmail);
    assertThat(result.get().getId()).isEqualTo(1L);

    verify(userRepository).findByEmail(testEmail);
}
```

### 2. ç•°å¸¸ç³»ãƒ†ã‚¹ãƒˆã® AAA ãƒ‘ã‚¿ãƒ¼ãƒ³

```java
@Test
@DisplayName("findByEmail: å­˜åœ¨ã—ãªã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ç©ºã®OptionalãŒè¿”ã‚‹")
void findByEmail_UserNotExists_ReturnsEmpty() {
    // ğŸ”§ Arrange - å­˜åœ¨ã—ãªã„ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã®æº–å‚™
    Email notFoundEmail = new Email("notfound@example.com");
    when(userRepository.findByEmail(notFoundEmail))
        .thenReturn(Optional.empty());

    // âš¡ Act - æ¤œç´¢ã®å®Ÿè¡Œ
    Optional<User> result = userRepository.findByEmail(notFoundEmail);

    // âœ… Assert - ç©ºã®çµæœã§ã‚ã‚‹ã“ã¨ã‚’æ¤œè¨¼
    assertThat(result).isEmpty();
    verify(userRepository).findByEmail(notFoundEmail);
}
```

### 3. ä¾‹å¤–ãƒ†ã‚¹ãƒˆã® AAA ãƒ‘ã‚¿ãƒ¼ãƒ³

```java
@Test
@DisplayName("findByEmail: nullãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã§ä¾‹å¤–ãŒç™ºç”Ÿã™ã‚‹")
void findByEmail_NullEmail_ThrowsException() {
    // ğŸ”§ Arrange - ä¾‹å¤–ã‚’ç™ºç”Ÿã•ã›ã‚‹ãƒ¢ãƒƒã‚¯è¨­å®š
    when(userRepository.findByEmail(null))
        .thenThrow(new IllegalArgumentException("Email cannot be null"));

    // âš¡ Act & âœ… Assert - ä¾‹å¤–ã®å®Ÿè¡Œã¨æ¤œè¨¼ã‚’åŒæ™‚ã«
    assertThatThrownBy(() -> userRepository.findByEmail(null))
        .isInstanceOf(IllegalArgumentException.class)
        .hasMessageContaining("Email cannot be null");

    verify(userRepository).findByEmail(null);
}
```

## ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã®å‘½åè¦å‰‡

### æ¨å¥¨å‘½åãƒ‘ã‚¿ãƒ¼ãƒ³

```
ãƒ¡ã‚½ãƒƒãƒ‰å_ãƒ†ã‚¹ãƒˆæ¡ä»¶_æœŸå¾…çµæœ()
```

### å®Ÿä¾‹

```java
// âœ… è‰¯ã„ä¾‹ï¼šæ„å›³ãŒæ˜ç¢º
void findByEmail_UserExists_ReturnsUser()
void findByEmail_UserNotExists_ReturnsEmpty()
void save_NewUser_ReturnsUserWithId()
void save_NullUser_ThrowsException()

// âŒ æ‚ªã„ä¾‹ï¼šæ„å›³ãŒä¸æ˜ç¢º
void testFindByEmail()
void testSave()
void userTest()
```

## ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿æº–å‚™ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### @BeforeEach ã§ã®å…±é€šãƒ‡ãƒ¼ã‚¿æº–å‚™

```java
@BeforeEach
void setUp() {
    // å„ãƒ†ã‚¹ãƒˆã§ä½¿ç”¨ã™ã‚‹å…±é€šãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
    testEmail = new Email("test@example.com");
    testUsername = new Username("testuser");
    testPasswordHash = new PasswordHash("password123");

    // IDæœªè¨­å®šã®æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼
    testUser = User.register(testEmail, testUsername, testPasswordHash);

    // IDè¨­å®šæ¸ˆã¿ã®æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼
    testUserWithId = new User(
        1L, testEmail, testUsername, testPasswordHash,
        new ArrayList<>(), Instant.now(), Instant.now()
    );
}
```

### ãƒ†ã‚¹ãƒˆå›ºæœ‰ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™

```java
@Test
@DisplayName("save: æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ›´æ–°ãŒæˆåŠŸã™ã‚‹")
void save_ExistingUser_ReturnsUpdatedUser() {
    // ğŸ”§ Arrange - ã“ã®ãƒ†ã‚¹ãƒˆå°‚ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’æº–å‚™
    User updatedUser = new User(
        1L,
        testEmail,
        new Username("updateduser"), // ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å¤‰æ›´
        testPasswordHash,
        new ArrayList<>(),
        Instant.now().minusSeconds(3600), // 1æ™‚é–“å‰ã«ä½œæˆ
        Instant.now() // ç¾åœ¨æ™‚åˆ»ã§æ›´æ–°
    );

    when(userRepository.save(testUserWithId)).thenReturn(updatedUser);

    // âš¡ Act
    User result = userRepository.save(testUserWithId);

    // âœ… Assert
    assertThat(result.getUsername().getValue()).isEqualTo("updateduser");
}
```

## ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆæ¤œè¨¼ï¼‰ã®ãƒã‚¤ãƒ³ãƒˆ

### AssertJ ã®æ´»ç”¨

```java
// âœ… èª­ã¿ã‚„ã™ã„ã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³
assertThat(result).isPresent();
assertThat(result.get().getEmail()).isEqualTo(testEmail);
assertThat(result.get().getId()).isNotNull();

// âœ… ä¾‹å¤–ã®è©³ç´°æ¤œè¨¼
assertThatThrownBy(() -> userRepository.findByEmail(null))
    .isInstanceOf(IllegalArgumentException.class)
    .hasMessageContaining("Email cannot be null");

// âœ… ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®æ¤œè¨¼
assertThat(userList)
    .hasSize(3)
    .extracting(User::getEmail)
    .containsExactly(email1, email2, email3);
```

### Mockito ã®æ¤œè¨¼

```java
// ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã—ã®æ¤œè¨¼
verify(userRepository).findByEmail(testEmail);
verify(userRepository, times(1)).save(any(User.class));
verify(userRepository, never()).delete(any());

// å¼•æ•°ã®è©³ç´°æ¤œè¨¼
verify(userRepository).save(argThat(user ->
    user.getEmail().equals(testEmail) &&
    user.getUsername().equals(testUsername)
));
```

## ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã¨ãƒ¬ãƒãƒ¼ãƒˆ

### Maven/Gradle ã§ã®ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ

```bash
# å…¨ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
mvn test

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆã‚¯ãƒ©ã‚¹ã®ã¿å®Ÿè¡Œ
mvn test -Dtest=UserRepositoryTest

# ç‰¹å®šã®ãƒ†ã‚¹ãƒˆãƒ¡ã‚½ãƒƒãƒ‰ã®ã¿å®Ÿè¡Œ
mvn test -Dtest=UserRepositoryTest#findByEmail_UserExists_ReturnsUser
```

### ãƒ†ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆã®ç¢ºèª

```
target/surefire-reports/
â”œâ”€â”€ TEST-UserRepositoryTest.xml     # JUnit XMLãƒ¬ãƒãƒ¼ãƒˆ
â””â”€â”€ UserRepositoryTest.txt          # ãƒ†ã‚­ã‚¹ãƒˆãƒ¬ãƒãƒ¼ãƒˆ
```

## ã¾ã¨ã‚

### AAA ãƒ‘ã‚¿ãƒ¼ãƒ³ã®åŠ¹æœ

```mermaid
mindmap
  root((AAAãƒ‘ã‚¿ãƒ¼ãƒ³))
    å¯èª­æ€§
      æ„å›³ã®æ˜ç¢ºåŒ–
      æ§‹é€ ã®çµ±ä¸€
    ä¿å®ˆæ€§
      å¤‰æ›´ç®‡æ‰€ã®ç‰¹å®š
      ãƒ‡ãƒãƒƒã‚°å®¹æ˜“æ€§
    å“è³ªå‘ä¸Š
      ç¶²ç¾…æ€§ã®ç¢ºä¿
      å›å¸°ãƒ†ã‚¹ãƒˆ
    ãƒãƒ¼ãƒ é–‹ç™º
      ã‚³ãƒ¼ãƒ‰çµ±ä¸€
      ãƒ¬ãƒ“ãƒ¥ãƒ¼åŠ¹ç‡åŒ–
```

### å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ

1. **å‘½åè¦å‰‡ã®å¾¹åº•**: `ãƒ¡ã‚½ãƒƒãƒ‰å_æ¡ä»¶_æœŸå¾…çµæœ`
2. **AAA ãƒ‘ã‚¿ãƒ¼ãƒ³ã®éµå®ˆ**: æº–å‚™ â†’ å®Ÿè¡Œ â†’ æ¤œè¨¼ã®æ˜ç¢ºãªåˆ†é›¢
3. **é©åˆ‡ãªã‚¢ã‚µãƒ¼ã‚·ãƒ§ãƒ³**: AssertJ ã¨ Mockito ã®åŠ¹æœçš„ãªæ´»ç”¨
4. **ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç®¡ç†**: å…±é€šãƒ‡ãƒ¼ã‚¿ã¨å€‹åˆ¥ãƒ‡ãƒ¼ã‚¿ã®ä½¿ã„åˆ†ã‘

JUnit5 ã¨ AAA ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€**èª­ã¿ã‚„ã™ãã€ä¿å®ˆã—ã‚„ã™ãã€ä¿¡é ¼æ€§ã®é«˜ã„**ãƒ†ã‚¹ãƒˆã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã§ãã¾ã™ã€‚ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™ºï¼ˆTDDï¼‰ã®å®Ÿè·µã«ã‚‚æ¬ ã‹ã›ãªã„æŠ€è¡“ã§ã™ã€‚

## å‚è€ƒè³‡æ–™

- [JUnit 5 User Guide](https://junit.org/junit5/docs/current/user-guide/)
- [Mockito Documentation](https://javadoc.io/doc/org.mockito/mockito-core/latest/org/mockito/Mockito.html)
- [AssertJ Documentation](https://assertj.github.io/doc/)
