# Spring Boot ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¼æ’­ã«ã¤ã„ã¦ï¼š@Transactional ã®é‡è¤‡ã¨åˆ†é›¢ãƒ‘ã‚¿ãƒ¼ãƒ³

## ã¯ã˜ã‚ã«

Spring Boot é–‹ç™ºã«ãŠã„ã¦ã€ã€ŒService å±¤ã¨ Repository å±¤ã®ä¸¡æ–¹ã« @Transactional ãŒä»˜ã„ã¦ã„ã‚‹ã‘ã©ã€ã“ã‚Œã£ã¦äºŒé‡ç®¡ç†ï¼Ÿã€ã¨ã„ã†ç–‘å•ã‚’æŒã£ãŸã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ

ã“ã®è¨˜äº‹ã§ã¯ã€Spring ã®**ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¼æ’­ï¼ˆTransaction Propagationï¼‰**ã®ä»•çµ„ã¿ã‚’ç†è§£ã—ã€é©åˆ‡ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œã®è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’è§£èª¬ã—ã¾ã™ã€‚

## ğŸ¯ æ ¸å¿ƒï¼šäºŒé‡ç®¡ç†ã§ã¯ãªãã€Œä¼æ’­ã€ã®ä»•çµ„ã¿

### âŒ é–“é•ã£ãŸç†è§£

ã€ŒService å±¤ã¨ Repository å±¤ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒäºŒé‡ã«å®Ÿè¡Œã•ã‚Œã‚‹ã€

### âœ… æ­£ã—ã„ç†è§£

ã€ŒService å±¤ãŒä¸»å¢ƒç•Œã€Repository å±¤ã¯æ—¢å­˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å‚åŠ ã€

## ğŸ“‹ å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³æ¯”è¼ƒ

### Service å±¤ï¼šãƒ¡ã‚¤ãƒ³ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œ

```java
@Service
@Transactional  // â† ã“ã“ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
public class RegisterUserService {

    public RegisterResponse register(RegisterUserCommand command) {
        // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
        userRepository.findByEmail(email);    // â† æ—¢å­˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å‚åŠ 
        userRepository.findByUsername(username); // â† æ—¢å­˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å‚åŠ 
        userRepository.save(newUser);         // â† æ—¢å­˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å‚åŠ 
        // ãƒ¡ã‚½ãƒƒãƒ‰å®Œäº†ã§ã‚³ãƒŸãƒƒãƒˆï¼ˆã¾ãŸã¯ã‚¨ãƒ©ãƒ¼æ™‚ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    }
}
```

### Repository å±¤ï¼šè£œå®Œçš„ãªãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¿è¨¼

```java
@Repository
@Transactional  // â† ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šPROPAGATION_REQUIRED
public class UserRepositoryJpaImpl {

    @Override
    @Transactional(readOnly = true)  // â† èª­ã¿å–ã‚Šå°‚ç”¨ã®æœ€é©åŒ–
    public Optional<User> findByEmail(Email email) {
        // Serviceå±¤ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å‚åŠ 
        // ãªã‘ã‚Œã°æ–°ã—ã„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹ï¼ˆç‹¬ç«‹å®Ÿè¡Œæ™‚ã®ä¿è¨¼ï¼‰
    }
}
```

## ğŸ” è©³ç´°è§£èª¬ï¼šãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¼æ’­ã®ä»•çµ„ã¿

### 1. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ä¼æ’­æ–¹å¼ï¼ˆPROPAGATION_REQUIREDï¼‰

```mermaid
sequenceDiagram
    participant Controller
    participant Service
    participant Repository
    participant DB

    Controller->>Service: register()
    Note over Service: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
    Service->>Repository: findByEmail()
    Note over Repository: æ—¢å­˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å‚åŠ 
    Repository->>DB: SELECT
    DB-->>Repository: çµæœ
    Service->>Repository: save()
    Note over Repository: åŒã˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
    Repository->>DB: INSERT
    DB-->>Repository: çµæœ
    Note over Service: ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†ï¼ˆã‚³ãƒŸãƒƒãƒˆï¼‰
    Service-->>Controller: çµæœ
```

### 2. å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ã®è©³ç´°

```java
// å®Ÿéš›ã®å‹•ä½œãƒ•ãƒ­ãƒ¼
1. RegisterUserService.register() å‘¼ã³å‡ºã—
2. Serviceå±¤ã§ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹ â†â”€â”€ ãƒ¡ã‚¤ãƒ³å¢ƒç•Œ
3. userRepository.findByEmail() â†’ æ—¢å­˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å‚åŠ 
4. userRepository.findByUsername() â†’ æ—¢å­˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å‚åŠ 
5. userRepository.save() â†’ æ—¢å­˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å‚åŠ 
6. Serviceå±¤ãƒ¡ã‚½ãƒƒãƒ‰å®Œäº†ã§ã‚³ãƒŸãƒƒãƒˆ â†â”€â”€ å…¨ä½“ã®æˆåŠŸ/å¤±æ•—ã‚’æ±ºå®š
```

## ğŸš€ å¿œç”¨ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼šãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³åˆ†é›¢

### ã‚±ãƒ¼ã‚¹ 1ï¼šãƒ­ã‚°è¨˜éŒ²ã‚’åˆ¥ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§å®Ÿè¡Œ

```java
@Service
public class RegisterUserService {

    @Transactional
    public RegisterResponse register(RegisterUserCommand command) {
        try {
            // ãƒ¡ã‚¤ãƒ³ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³
            User user = userRepository.save(newUser);

            // åˆ¥ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ãƒ­ã‚°ï¼ˆå¤±æ•—ã—ã¦ã‚‚ãƒ¡ã‚¤ãƒ³å‡¦ç†ã«å½±éŸ¿ã—ãªã„ï¼‰
            auditService.logUserRegistration(user);

            return RegisterResponse.from(user);
        } catch (Exception e) {
            // ãƒ¡ã‚¤ãƒ³ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯
            // ã§ã‚‚ãƒ­ã‚°ã¯æ®‹ã‚‹
            throw e;
        }
    }
}

@Service
public class AuditService {

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void logUserRegistration(User user) {
        // æ–°ã—ã„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
        // ãƒ¡ã‚¤ãƒ³å‡¦ç†ã®æˆåŠŸ/å¤±æ•—ã«é–¢ä¿‚ãªãå®Ÿè¡Œã•ã‚Œã‚‹
        auditRepository.save(new AuditLog(user));
    }
}
```

### ã‚±ãƒ¼ã‚¹ 2ï¼šã‚¨ãƒ©ãƒ¼é€šçŸ¥ã‚’ç¢ºå®Ÿã«å®Ÿè¡Œ

```java
@Service
public class PaymentService {

    @Transactional
    public PaymentResult processPayment(PaymentCommand command) {
        try {
            // æ±ºæ¸ˆå‡¦ç†ï¼ˆãƒ¡ã‚¤ãƒ³ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
            Payment payment = paymentRepository.save(newPayment);
            return PaymentResult.success(payment);

        } catch (PaymentException e) {
            // ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã¯åˆ¥ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ç¢ºå®Ÿã«å®Ÿè¡Œ
            notificationService.notifyPaymentFailure(command);
            throw e;
        }
    }
}

@Service
public class NotificationService {

    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void notifyPaymentFailure(PaymentCommand command) {
        // æ±ºæ¸ˆãŒå¤±æ•—ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼é€šçŸ¥ã¯ç¢ºå®Ÿã«è¨˜éŒ²ã•ã‚Œã‚‹
        errorLogRepository.save(new ErrorLog(command));
        emailService.sendErrorNotification(command.getUserEmail());
    }
}
```

## ğŸ“Š ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¼æ’­ã®ç¨®é¡

| ä¼æ’­ã‚¿ã‚¤ãƒ—               | å‹•ä½œ                               | ç”¨é€”                       |
| ------------------------ | ---------------------------------- | -------------------------- |
| `REQUIRED`ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ | æ—¢å­˜ãŒã‚ã‚Œã°å‚åŠ ã€ãªã‘ã‚Œã°æ–°è¦ä½œæˆ | é€šå¸¸ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯     |
| `REQUIRES_NEW`           | å¸¸ã«æ–°ã—ã„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä½œæˆ     | ãƒ­ã‚°è¨˜éŒ²ã€ç›£æŸ»ã€ã‚¨ãƒ©ãƒ¼é€šçŸ¥ |
| `NOT_SUPPORTED`          | ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãªã—ã§å®Ÿè¡Œ         | èª­ã¿å–ã‚Šå°‚ç”¨ã®é‡ã„å‡¦ç†     |
| `MANDATORY`              | æ—¢å­˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¿…é ˆ           | å‘¼ã³å‡ºã—å…ƒã§ã®äº‹å‰ãƒã‚§ãƒƒã‚¯ |

### å®Ÿè£…ä¾‹

```java
@Service
public class UserService {

    // 1. ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼šæ—¢å­˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å‚åŠ 
    @Transactional(propagation = Propagation.REQUIRED)
    public void updateUser(User user) { ... }

    // 2. æ–°ã—ã„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ï¼šç‹¬ç«‹å®Ÿè¡Œ
    @Transactional(propagation = Propagation.REQUIRES_NEW)
    public void logUserActivity(User user) { ... }

    // 3. ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãªã—ï¼šé‡ã„èª­ã¿å–ã‚Šå‡¦ç†
    @Transactional(propagation = Propagation.NOT_SUPPORTED)
    public List<User> generateHeavyReport() { ... }

    // 4. å¿…é ˆï¼šå‘¼ã³å‡ºã—å…ƒã«ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒå¿…è¦
    @Transactional(propagation = Propagation.MANDATORY)
    public void criticalOperation(User user) { ... }
}
```

## ğŸ›¡ï¸ è¨­è¨ˆæŒ‡é‡ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. åŸºæœ¬åŸå‰‡

```java
// âœ… Serviceå±¤ï¼šãƒ“ã‚¸ãƒã‚¹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã®å¢ƒç•Œ
@Service
@Transactional  // ã‚¯ãƒ©ã‚¹ãƒ¬ãƒ™ãƒ«ã§ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæŒ‡å®š
public class UserService {

    @Transactional(readOnly = true)  // èª­ã¿å–ã‚Šå°‚ç”¨ã¯æ˜ç¤º
    public User findUser(Long id) { ... }

    // æ›¸ãè¾¼ã¿ç³»ã¯ã‚¯ãƒ©ã‚¹ãƒ¬ãƒ™ãƒ«ã®è¨­å®šã‚’ç¶™æ‰¿
    public User createUser(CreateUserCommand command) { ... }
}

// âœ… Repositoryå±¤ï¼šæŠ€è¡“çš„ãªä¿è¨¼
@Repository
@Transactional  // ç‹¬ç«‹å®Ÿè¡Œæ™‚ã®ä¿è¨¼
public class UserRepositoryJpaImpl {

    @Override
    @Transactional(readOnly = true)  // èª­ã¿å–ã‚Šæœ€é©åŒ–
    public Optional<User> findById(Long id) { ... }
}
```

### 2. åˆ†é›¢ãŒå¿…è¦ãªã‚±ãƒ¼ã‚¹

```java
// ãƒ­ã‚°ãƒ»ç›£æŸ»ãƒ»é€šçŸ¥ãªã©ã€ãƒ¡ã‚¤ãƒ³å‡¦ç†ã¨ç‹¬ç«‹ã•ã›ãŸã„å ´åˆ
@Transactional(propagation = Propagation.REQUIRES_NEW)
public void auditOperation(String operation, Object data) {
    // ãƒ¡ã‚¤ãƒ³å‡¦ç†ãŒå¤±æ•—ã—ã¦ã‚‚ãƒ­ã‚°ã¯æ®‹ã‚‹
}

// å¤–éƒ¨APIå‘¼ã³å‡ºã—ãªã©ã€ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒä¸è¦ãªå ´åˆ
@Transactional(propagation = Propagation.NOT_SUPPORTED)
public void callExternalApi(String data) {
    // ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãªã—ã§å®Ÿè¡Œ
}
```

## ğŸ¯ ã¾ã¨ã‚

1. **Service å±¤ã¨ Repository å±¤ã®@Transactional ã¯äºŒé‡ç®¡ç†ã§ã¯ãªã„**

   - Service å±¤ï¼šãƒ¡ã‚¤ãƒ³ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³å¢ƒç•Œ
   - Repository å±¤ï¼šæ—¢å­˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã«å‚åŠ ï¼ˆè£œå®Œçš„ä¿è¨¼ï¼‰

2. **ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯ PROPAGATION_REQUIRED**

   - æ—¢å­˜ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚Œã°å‚åŠ 
   - ãªã‘ã‚Œã°æ–°ã—ã„ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹

3. **åˆ†é›¢ãŒå¿…è¦ãªå ´åˆã¯æ˜ç¤ºçš„ã«æŒ‡å®š**

   - `REQUIRES_NEW`ï¼šãƒ­ã‚°è¨˜éŒ²ã€ç›£æŸ»ã€ã‚¨ãƒ©ãƒ¼é€šçŸ¥
   - `NOT_SUPPORTED`ï¼šé‡ã„èª­ã¿å–ã‚Šå‡¦ç†ã€å¤–éƒ¨ API å‘¼ã³å‡ºã—

4. **è¨­è¨ˆã®åŸºæœ¬æ–¹é‡**
   - Service å±¤ï¼šãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®æ•´åˆæ€§ã‚’ä¿è¨¼
   - Repository å±¤ï¼šæŠ€è¡“çš„ãªå®‰å…¨æ€§ã‚’ä¿è¨¼
   - ç‰¹åˆ¥ãªè¦ä»¶ãŒã‚ã‚‹å ´åˆã®ã¿ä¼æ’­æ–¹å¼ã‚’å¤‰æ›´

Spring ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ä¼æ’­ã«ã¤ã„ã¦åˆ†ã‹ã‚‰ãªã„éƒ¨åˆ†ã‚’èª¿ã¹ã¦ã¿ã¾ã—ãŸã€‚

ä»¥ä¸Šã§ã™ã€‚

---
