# Spring Boot ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½å®Ÿè£…ã‚¬ã‚¤ãƒ‰: DDD ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«ã‚ˆã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼è¨­è¨ˆ

## ã¯ã˜ã‚ã«

Spring Boot ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½ã‚’å®Ÿè£…ã™ã‚‹éš›ã€ã€Œã©ã®ã‚ˆã†ãªé †åºã§å®Ÿè£…ã™ã¹ãã‹ï¼Ÿã€ã€Œãƒ‡ãƒ¼ã‚¿ã¯ã©ã®ã‚ˆã†ã«æµã‚Œã‚‹ã¹ãã‹ï¼Ÿã€ã¨ã„ã†ç–‘å•ã‚’æŒã£ãŸã“ã¨ã¯ã‚ã‚Šã¾ã›ã‚“ã‹ï¼Ÿ

ã“ã®è¨˜äº‹ã§ã¯ã€DDDï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆï¼‰ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã«åŸºã¥ã„ã¦ã€å®Ÿéš›ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½ã‚’æ®µéšçš„ã«å®Ÿè£…ã™ã‚‹éç¨‹ã¨ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã‚’è§£èª¬ã—ã¾ã™ã€‚

## ğŸ¯ å®Ÿè£…ç›®æ¨™

```java
@PostMapping("/register")
public ResponseEntity<UserRegisteredResult> register(@RequestBody RegisterUserCommand command) {
    UserRegisteredResult result = registerUserService.register(command);
    return ResponseEntity.ok(result);
}
```

ã“ã® API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å®Œæˆã•ã›ã‚‹ã¾ã§ã®å…¨å·¥ç¨‹ã‚’è¿½è·¡ã—ã¾ã™ã€‚

## ğŸ—ï¸ ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¦‚è¦

### ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹æˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   API å±¤        â”‚ â† Controller (HTTPãƒ¬ã‚¹ãƒãƒ³ã‚¹)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Application å±¤  â”‚ â† Service (ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Domain å±¤      â”‚ â† Entity, ValueObject (ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ«)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚Infrastructureå±¤ â”‚ â† Repository (ãƒ‡ãƒ¼ã‚¿æ°¸ç¶šåŒ–)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

```
HTTP Request â†’ Command â†’ Service â†’ Domain â†’ Repository â†’ Database
                â†“
HTTP Response â† DTO â† Service â† Domain â† Repository â† Database
```

## ğŸ“‹ å®Ÿè£…æ‰‹é †ã¨ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### Phase 1: å…¥åŠ›ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆ (Command ãƒ‘ã‚¿ãƒ¼ãƒ³)

#### 1-1. RegisterUserCommand ã®å®Ÿè£…

```java
public class RegisterUserCommand {
    @NotNull @Email
    private String email;

    @NotNull @Size(min = 8, max = 100)
    private String password;

    @NotNull @Pattern(regexp = "^[a-zA-Z0-9_-]+$")
    private String username;

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ï¼ˆJacksonç”¨ï¼‰
    public RegisterUserCommand() {}

    // ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå¤‰æ›ãƒ¡ã‚½ãƒƒãƒ‰
    public Email toEmail() { return new Email(this.email); }
    public Username toUsername() { return new Username(this.username); }
}
```

**ãƒã‚¤ãƒ³ãƒˆ:**

- JSON â†’ Java ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå¤‰æ›ã®ãŸã‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒå¿…é ˆ
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§å…¥åŠ›ãƒã‚§ãƒƒã‚¯
- ãƒ‰ãƒ¡ã‚¤ãƒ³å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¸ã®å¤‰æ›ãƒ¡ã‚½ãƒƒãƒ‰æä¾›

#### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆå…¥åŠ›ï¼‰

```
HTTP JSON Request â†’ Jackson â†’ RegisterUserCommand
```

### Phase 2: å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿è¨­è¨ˆ (DTO ãƒ‘ã‚¿ãƒ¼ãƒ³)

#### 2-1. UserRegisteredResult ã®å®Ÿè£…

```java
public class UserRegisteredResult {
    private Long userId;
    private String email;
    private String username;
    private LocalDateTime createdAt;

    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ï¼ˆJacksonç”¨ï¼‰
    public UserRegisteredResult() {}

    // ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå¤‰æ›ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰
    public static UserRegisteredResult from(User user) {
        return new UserRegisteredResult(
            user.getId(),
            user.getEmail().getValue(),
            user.getUsername().getValue(),
            user.getCreatedAt().atZone(ZoneId.systemDefault()).toLocalDateTime()
        );
    }
}
```

**ãƒã‚¤ãƒ³ãƒˆ:**

- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ã¯å«ã¾ãªã„
- ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰: ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰ã®å¤‰æ›
- æ™‚åˆ»å¤‰æ›: Instant â†’ LocalDateTimeï¼ˆAPI ç”¨ï¼‰

#### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ï¼ˆå‡ºåŠ›ï¼‰

```
User Domain Object â†’ UserRegisteredResult â†’ Jackson â†’ HTTP JSON Response
```

### Phase 3: Service å±¤å®Ÿè£…

#### 3-1. RegisterUserService ã®å®Ÿè£…

```java
@Service
@Transactional
public class RegisterUserService {
    private final UserRepository userRepository;

    public UserRegisteredResult register(RegisterUserCommand command) {
        // 1. ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³å€¤ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«å¤‰æ›
        Email email = command.toEmail();
        Username username = command.toUsername();

        // 2. ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹é‡è¤‡ãƒã‚§ãƒƒã‚¯
        Optional<User> existingUserByEmail = userRepository.findByEmail(email);
        if(existingUserByEmail.isPresent()){
            throw new DuplicateEmailException(email.getValue());
        }

        // 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼åé‡è¤‡ãƒã‚§ãƒƒã‚¯
        Optional<User> existingUserByUsername = userRepository.findByUsername(username);
        if(existingUserByUsername.isPresent()){
            throw new DuplicateUsernameException(username.getValue());
        }

        // 4. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥åŒ–ï¼ˆPasswordHashã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿å†…ã§è‡ªå‹•å®Ÿè¡Œï¼‰
        PasswordHash passwordHash = new PasswordHash(command.getPassword());

        // 5. Userãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ç”Ÿæˆï¼ˆãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰ä½¿ç”¨ï¼‰
        User newUser = User.register(email, username, passwordHash);

        // 6. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ°¸ç¶šåŒ–ï¼ˆIDãŒè‡ªå‹•æ¡ç•ªã•ã‚Œã‚‹ï¼‰
        User savedUser = userRepository.save(newUser);

        // 7. ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã‚’DTOã«å¤‰æ›ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã«æº–å‚™
        return UserRegisteredResult.from(savedUser);
    }
}
```

**ãƒã‚¤ãƒ³ãƒˆ:**

- å˜ä¸€è²¬ä»»: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿
- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³: @Transactional ã§ãƒ‡ãƒ¼ã‚¿æ•´åˆæ€§ä¿è¨¼
- ä¾‹å¤–å‡¦ç†: ãƒ‰ãƒ¡ã‚¤ãƒ³ä¾‹å¤–ã‚’ãã®ã¾ã¾ã‚¹ãƒ­ãƒ¼ï¼ˆGlobal Handler ã§å‡¦ç†ï¼‰

#### ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼ã®è©³ç´°

```
1. Command â†’ Domain ValueObject (å¤‰æ›)
2. Domain ValueObject â†’ Repository (é‡è¤‡ãƒã‚§ãƒƒã‚¯)
3. Plain Password â†’ PasswordHash (ãƒãƒƒã‚·ãƒ¥åŒ–)
4. ValueObjects â†’ User Domain (ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰)
5. User Domain â†’ Repository â†’ Database (æ°¸ç¶šåŒ–)
6. User Domain â†’ DTO (å¤‰æ›)
```

## ğŸ¨ è¨­è¨ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã¨åŸå‰‡

### 1. Command Query Responsibility Segregation (CQRS)

- **Command**: RegisterUserCommandï¼ˆæ›¸ãè¾¼ã¿ç”¨ï¼‰
- **Query**: UserRegisteredResultï¼ˆèª­ã¿è¾¼ã¿ç”¨ï¼‰

### 2. Factory ãƒ‘ã‚¿ãƒ¼ãƒ³

```java
// ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆç”Ÿæˆ
User newUser = User.register(email, username, passwordHash);

// DTOç”Ÿæˆ
UserRegisteredResult result = UserRegisteredResult.from(savedUser);
```

### 3. Repository ãƒ‘ã‚¿ãƒ¼ãƒ³

```java
// ãƒ‰ãƒ¡ã‚¤ãƒ³å±¤ã§ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å®šç¾©
public interface UserRepository {
    Optional<User> findByEmail(Email email);
    User save(User user);
}
```

### 4. Value Object ãƒ‘ã‚¿ãƒ¼ãƒ³

```java
// å‹å®‰å…¨æ€§ã¨ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
Email email = new Email("user@example.com");  // è‡ªå‹•ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
Username username = new Username("john_doe");  // è‡ªå‹•æ­£è¦åŒ–
```

## ğŸ”„ å®Œå…¨ãªãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼å›³

```
HTTP Request (JSON)
       â†“
RegisterUserCommand (Command)
       â†“
Service Layer (Business Logic)
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Command â†’ ValueObject       â”‚
â”‚ 2. Duplicate Check (Repository) â”‚
â”‚ 3. Password Hashing             â”‚
â”‚ 4. Domain Model Creation        â”‚
â”‚ 5. Database Persistence         â”‚
â”‚ 6. Domain â†’ DTO Conversion      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“
UserRegisteredResult (DTO)
       â†“
HTTP Response (JSON)
```

## ğŸš€ å®Ÿè£…ã®åˆ©ç‚¹

### 1. **ãƒ¬ã‚¤ãƒ¤ãƒ¼åˆ†é›¢**

- å„å±¤ãŒç‹¬ç«‹ã—ã¦å¤‰æ›´å¯èƒ½
- ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ã®å‘ä¸Š

### 2. **å‹å®‰å…¨æ€§**

- Value Object ã«ã‚ˆã‚‹ä¸æ­£å€¤ã®æ’é™¤
- ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã‚¨ãƒ©ãƒ¼æ¤œå‡º

### 3. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**

- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒãƒƒã‚·ãƒ¥ã®è‡ªå‹•åŒ–
- æ©Ÿå¯†æƒ…å ±ã®éœ²å‡ºé˜²æ­¢

### 4. **ä¿å®ˆæ€§**

- ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã®ä¸€å…ƒç®¡ç†
- ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã®ä¿è­·

## ğŸ¯ å®Ÿè£…æ™‚ã®ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ

### Command ã‚¯ãƒ©ã‚¹

- [ ] ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã®å®Ÿè£…
- [ ] ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
- [ ] ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå¤‰æ›ãƒ¡ã‚½ãƒƒãƒ‰

### DTO ã‚¯ãƒ©ã‚¹

- [ ] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æƒ…å ±ã®é™¤å¤–
- [ ] ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¡ã‚½ãƒƒãƒ‰ã®å®Ÿè£…
- [ ] æ™‚åˆ»å¤‰æ›ã®é©åˆ‡ãªå‡¦ç†

### Service ã‚¯ãƒ©ã‚¹

- [ ] @Transactional ã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³
- [ ] é‡è¤‡ãƒã‚§ãƒƒã‚¯ã®å®Ÿè£…
- [ ] ä¾‹å¤–å‡¦ç†ã®é©åˆ‡ãªè¨­è¨ˆ
- [ ] å‡¦ç†ãƒ•ãƒ­ãƒ¼ã®ã‚³ãƒ¡ãƒ³ãƒˆè¨˜è¼‰

## ã¾ã¨ã‚

Spring Boot ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½å®Ÿè£…ã¯ã€ä»¥ä¸‹ã®é †åºã§æ®µéšçš„ã«é€²ã‚ã‚‹ã“ã¨ã§ã€ä¿å®ˆæ€§ã¨å®‰å…¨æ€§ã‚’ä¸¡ç«‹ã§ãã¾ã™ï¼š

1. **Command è¨­è¨ˆ**: å…¥åŠ›ãƒ‡ãƒ¼ã‚¿ã®å‹å®‰å…¨æ€§ç¢ºä¿
2. **DTO è¨­è¨ˆ**: å‡ºåŠ›ãƒ‡ãƒ¼ã‚¿ã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é…æ…®
3. **Service å®Ÿè£…**: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ä¸€å…ƒç®¡ç†

ã“ã®å®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ã‚ˆã‚Šã€è¦ä»¶å¤‰æ›´ã«å¼·ãã€ãƒ†ã‚¹ãƒˆå¯èƒ½ã§ã€ã‚»ã‚­ãƒ¥ã‚¢ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½ã‚’æ§‹ç¯‰ã§ãã¾ã™ã€‚

## å‚è€ƒè³‡æ–™

- [Domain-Driven Design: Tackling Complexity in the Heart of Software](https://www.amazon.com/Domain-Driven-Design-Tackling-Complexity-Software/dp/0321125215)
- [Spring Boot Reference Documentation](https://docs.spring.io/spring-boot/docs/current/reference/html/)
- [Clean Architecture: A Craftsman's Guide to Software Structure and Design](https://www.amazon.com/Clean-Architecture-Craftsmans-Software-Structure/dp/0134494164)

---

ã“ã®è¨˜äº‹ãŒ Spring Boot ã§ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²æ©Ÿèƒ½å®Ÿè£…ã®ç†è§£ã«å½¹ç«‹ã¦ã°å¹¸ã„ã§ã™ï¼
